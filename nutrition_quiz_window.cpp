#include "nutrition_quiz_window.h"
#include <QApplication>
#include <QScreen>
#include <QDebug>
#include <QRandomGenerator>
#include <QFont>
#include <QGraphicsDropShadowEffect>

NutritionQuizWindow::NutritionQuizWindow(QWidget *parent)
    : QWidget(parent)
    , currentKnowledgeIndex(0)
    , currentQuestionIndex(0)
    , correctAnswers(0)
    , totalQuestions(5)
{
    setupUI();
    applyStyles();
    
    // ËÆæÁΩÆÁ™óÂè£Â±ûÊÄß
    setWindowTitle("„Å°„ÅÑ„Åã„ÇèËê•ÂÖªÂ§ßÂÜíÈô© - Ëê•ÂÖªÁü•ËØÜÂÆùÂÖ∏");
    setFixedSize(800, 600);
    
    // Â±Ö‰∏≠ÊòæÁ§∫
    QScreen *screen = QApplication::primaryScreen();
    QRect screenGeometry = screen->geometry();
    int x = (screenGeometry.width() - width()) / 2;
    int y = (screenGeometry.height() - height()) / 2;
    move(x, y);
    
    // ËøûÊé•Êï∞ÊçÆÂ∫ì
    database = QSqlDatabase::database();
    if (!database.isOpen()) {
        qDebug() << "Êï∞ÊçÆÂ∫ìÊú™ËøûÊé•ÔºåÂ∞ùËØïÈáçÊñ∞ËøûÊé•...";
        database = QSqlDatabase::addDatabase("QSQLITE", "quiz_connection");
        QString dbPath = QApplication::applicationDirPath() + "/chiikawa_game.db";
        database.setDatabaseName(dbPath);
        if (!database.open()) {
            qDebug() << "Á≠îÈ¢òÁïåÈù¢Êï∞ÊçÆÂ∫ìËøûÊé•Â§±Ë¥•:" << database.lastError().text();
        }
    }
}

NutritionQuizWindow::~NutritionQuizWindow()
{
    if (database.isOpen() && database.connectionName() == "quiz_connection") {
        database.close();
    }
}

void NutritionQuizWindow::setupUI()
{
    stackedWidget = new QStackedWidget(this);
    
    setupKnowledgeUI();
    setupQuizUI();
    
    // ‰∏ªÂ∏ÉÂ±Ä
    QVBoxLayout* layout = new QVBoxLayout(this);
    layout->addWidget(stackedWidget);
    layout->setContentsMargins(0, 0, 0, 0);
    
    // ÈªòËÆ§ÊòæÁ§∫‰∏ªÁïåÈù¢
    stackedWidget->setCurrentWidget(mainWidget);
}

void NutritionQuizWindow::setupKnowledgeUI()
{
    // ‰∏ªÁïåÈù¢
    mainWidget = new QWidget();
    mainLayout = new QVBoxLayout(mainWidget);
    
    titleLabel = new QLabel("Ëê•ÂÖªÁü•ËØÜÂÆùÂÖ∏");
    titleLabel->setAlignment(Qt::AlignCenter);
    titleLabel->setObjectName("titleLabel");
    
    messageLabel = new QLabel("ÂæàÈÅóÊÜæÔºåÊ∏∏ÊàèÂ§±Ë¥•‰∫ÜÔºÅ\n‰∏çËøáÊ≤°ÂÖ≥Á≥ªÔºåËÆ©Êàë‰ª¨‰∏ÄËµ∑Â≠¶‰π†Ëê•ÂÖªÁü•ËØÜÂêßÔºÅ");
    messageLabel->setAlignment(Qt::AlignCenter);
    messageLabel->setObjectName("messageLabel");
    
    knowledgeButton = new QPushButton("üìñ ÊâìÂºÄÂÆùÂÖ∏");
    knowledgeButton->setObjectName("knowledgeButton");
    connect(knowledgeButton, &QPushButton::clicked, this, &NutritionQuizWindow::onKnowledgeButtonClicked);
    
    mainLayout->addStretch();
    mainLayout->addWidget(titleLabel);
    mainLayout->addSpacing(30);
    mainLayout->addWidget(messageLabel);
    mainLayout->addSpacing(50);
    mainLayout->addWidget(knowledgeButton, 0, Qt::AlignCenter);
    mainLayout->addStretch();
    
    stackedWidget->addWidget(mainWidget);
    
    // Áü•ËØÜÂÆùÂÖ∏ÁïåÈù¢
    knowledgeWidget = new QWidget();
    knowledgeLayout = new QVBoxLayout(knowledgeWidget);
    
    knowledgeTitleLabel = new QLabel("Ëê•ÂÖªÁü•ËØÜÂÆùÂÖ∏");
    knowledgeTitleLabel->setAlignment(Qt::AlignCenter);
    knowledgeTitleLabel->setObjectName("knowledgeTitleLabel");
    
    knowledgeScrollArea = new QScrollArea();
    knowledgeContentEdit = new QTextEdit();
    knowledgeContentEdit->setReadOnly(true);
    knowledgeContentEdit->setObjectName("knowledgeContentEdit");
    knowledgeScrollArea->setWidget(knowledgeContentEdit);
    knowledgeScrollArea->setWidgetResizable(true);
    
    knowledgeProgressBar = new QProgressBar();
    knowledgeProgressBar->setObjectName("knowledgeProgressBar");
    
    knowledgeNavLayout = new QHBoxLayout();
    prevKnowledgeButton = new QPushButton("‚¨ÖÔ∏è ‰∏ä‰∏ÄÈ°µ");
    nextKnowledgeButton = new QPushButton("‰∏ã‰∏ÄÈ°µ ‚û°Ô∏è");
    nextStepButton = new QPushButton("üìù ÂºÄÂßãÁ≠îÈ¢ò");
    
    prevKnowledgeButton->setObjectName("navButton");
    nextKnowledgeButton->setObjectName("navButton");
    nextStepButton->setObjectName("nextStepButton");
    
    connect(prevKnowledgeButton, &QPushButton::clicked, [this]() {
        if (currentKnowledgeIndex > 0) {
            currentKnowledgeIndex--;
            updateKnowledgeDisplay(currentKnowledgeIndex);
        }
    });
    
    connect(nextKnowledgeButton, &QPushButton::clicked, [this]() {
        if (currentKnowledgeIndex < knowledgeItems.size() - 1) {
            currentKnowledgeIndex++;
            updateKnowledgeDisplay(currentKnowledgeIndex);
        }
    });
    
    connect(nextStepButton, &QPushButton::clicked, this, &NutritionQuizWindow::onNextStepClicked);
    
    knowledgeNavLayout->addWidget(prevKnowledgeButton);
    knowledgeNavLayout->addStretch();
    knowledgeNavLayout->addWidget(nextStepButton);
    knowledgeNavLayout->addStretch();
    knowledgeNavLayout->addWidget(nextKnowledgeButton);
    
    knowledgeLayout->addWidget(knowledgeTitleLabel);
    knowledgeLayout->addWidget(knowledgeProgressBar);
    knowledgeLayout->addSpacing(20);
    knowledgeLayout->addWidget(knowledgeScrollArea);
    knowledgeLayout->addSpacing(20);
    knowledgeLayout->addLayout(knowledgeNavLayout);
    
    stackedWidget->addWidget(knowledgeWidget);
}

void NutritionQuizWindow::setupQuizUI()
{
    // Á≠îÈ¢òÁïåÈù¢
    quizWidget = new QWidget();
    quizLayout = new QVBoxLayout(quizWidget);
    
    quizTitleLabel = new QLabel("Ëê•ÂÖªÁü•ËØÜÈóÆÁ≠î");
    quizTitleLabel->setAlignment(Qt::AlignCenter);
    quizTitleLabel->setObjectName("quizTitleLabel");
    
    quizProgressBar = new QProgressBar();
    quizProgressBar->setObjectName("quizProgressBar");
    
    scoreLabel = new QLabel("ÂæóÂàÜ: 0/0");
    scoreLabel->setAlignment(Qt::AlignCenter);
    scoreLabel->setObjectName("scoreLabel");
    
    questionLabel = new QLabel();
    questionLabel->setWordWrap(true);
    questionLabel->setObjectName("questionLabel");
    
    // ÈÄâÈ°πÊåâÈíÆ
    answerButtonGroup = new QButtonGroup(this);
    optionAButton = new QRadioButton();
    optionBButton = new QRadioButton();
    optionCButton = new QRadioButton();
    optionDButton = new QRadioButton();
    
    optionAButton->setObjectName("optionButton");
    optionBButton->setObjectName("optionButton");
    optionCButton->setObjectName("optionButton");
    optionDButton->setObjectName("optionButton");
    
    answerButtonGroup->addButton(optionAButton, 0);
    answerButtonGroup->addButton(optionBButton, 1);
    answerButtonGroup->addButton(optionCButton, 2);
    answerButtonGroup->addButton(optionDButton, 3);
    
    connect(answerButtonGroup, &QButtonGroup::buttonClicked,
            this, [this](QAbstractButton*) { onAnswerSelected(); });
    
    submitAnswerButton = new QPushButton("Êèê‰∫§Á≠îÊ°à");
    submitAnswerButton->setObjectName("submitButton");
    submitAnswerButton->setEnabled(false);
    connect(submitAnswerButton, &QPushButton::clicked, this, &NutritionQuizWindow::onSubmitAnswerClicked);
    
    resultLabel = new QLabel();
    resultLabel->setAlignment(Qt::AlignCenter);
    resultLabel->setObjectName("resultLabel");
    resultLabel->hide();
    
    explanationEdit = new QTextEdit();
    explanationEdit->setReadOnly(true);
    explanationEdit->setObjectName("explanationEdit");
    explanationEdit->setMaximumHeight(100);
    explanationEdit->hide();
    
    nextQuestionButton = new QPushButton("‰∏ã‰∏ÄÈ¢ò");
    nextQuestionButton->setObjectName("nextQuestionButton");
    nextQuestionButton->hide();
    connect(nextQuestionButton, &QPushButton::clicked, this, &NutritionQuizWindow::onNextQuestionClicked);
    
    quizLayout->addWidget(quizTitleLabel);
    quizLayout->addWidget(quizProgressBar);
    quizLayout->addWidget(scoreLabel);
    quizLayout->addSpacing(20);
    quizLayout->addWidget(questionLabel);
    quizLayout->addSpacing(15);
    quizLayout->addWidget(optionAButton);
    quizLayout->addWidget(optionBButton);
    quizLayout->addWidget(optionCButton);
    quizLayout->addWidget(optionDButton);
    quizLayout->addSpacing(20);
    quizLayout->addWidget(submitAnswerButton, 0, Qt::AlignCenter);
    quizLayout->addWidget(resultLabel);
    quizLayout->addWidget(explanationEdit);
    quizLayout->addWidget(nextQuestionButton, 0, Qt::AlignCenter);
    quizLayout->addStretch();
    
    stackedWidget->addWidget(quizWidget);
    
    // ÁªìÊûúÁïåÈù¢
    resultWidget = new QWidget();
    resultLayout = new QVBoxLayout(resultWidget);
    
    finalResultLabel = new QLabel();
    finalResultLabel->setAlignment(Qt::AlignCenter);
    finalResultLabel->setObjectName("finalResultLabel");
    
    finalScoreLabel = new QLabel();
    finalScoreLabel->setAlignment(Qt::AlignCenter);
    finalScoreLabel->setObjectName("finalScoreLabel");
    
    QHBoxLayout* finalButtonLayout = new QHBoxLayout();
    retryButton = new QPushButton("üîÑ ÈáçÊñ∞Á≠îÈ¢ò");
    backToMenuButton = new QPushButton("üè† ËøîÂõû‰∏ªËèúÂçï");
    
    retryButton->setObjectName("finalButton");
    backToMenuButton->setObjectName("finalButton");
    
    connect(retryButton, &QPushButton::clicked, this, &NutritionQuizWindow::onRetryClicked);
    connect(backToMenuButton, &QPushButton::clicked, this, &NutritionQuizWindow::onBackToMenuClicked);
    
    finalButtonLayout->addWidget(retryButton);
    finalButtonLayout->addSpacing(20);
    finalButtonLayout->addWidget(backToMenuButton);
    
    resultLayout->addStretch();
    resultLayout->addWidget(finalResultLabel);
    resultLayout->addSpacing(30);
    resultLayout->addWidget(finalScoreLabel);
    resultLayout->addSpacing(50);
    resultLayout->addLayout(finalButtonLayout);
    resultLayout->addStretch();
    
    stackedWidget->addWidget(resultWidget);
}

void NutritionQuizWindow::applyStyles()
{
    setStyleSheet(
        "QWidget {"
        "    background: qlineargradient(x1:0, y1:0, x2:0, y2:1, "
        "                                stop:0 #e8f4fd, stop:1 #b3d9ff);"
        "    font-family: 'Microsoft YaHei', 'SimHei', sans-serif;"
        "}"
        
        "#titleLabel, #knowledgeTitleLabel, #quizTitleLabel {"
        "    font-size: 28px;"
        "    font-weight: bold;"
        "    color: #2c3e50;"
        "    margin: 20px;"
        "}"
        
        "#messageLabel {"
        "    font-size: 16px;"
        "    color: #34495e;"
        "    line-height: 1.6;"
        "}"
        
        "#knowledgeButton, #nextStepButton {"
        "    font-size: 18px;"
        "    font-weight: bold;"
        "    color: white;"
        "    background: qlineargradient(x1:0, y1:0, x2:0, y2:1, "
        "                                stop:0 #3498db, stop:1 #2980b9);"
        "    border: none;"
        "    border-radius: 25px;"
        "    padding: 15px 30px;"
        "    min-width: 200px;"
        "}"
        
        "#knowledgeButton:hover, #nextStepButton:hover {"
        "    background: qlineargradient(x1:0, y1:0, x2:0, y2:1, "
        "                                stop:0 #2980b9, stop:1 #1f5f8b);"
        "}"
        
        "#navButton {"
        "    font-size: 14px;"
        "    color: white;"
        "    background: qlineargradient(x1:0, y1:0, x2:0, y2:1, "
        "                                stop:0 #95a5a6, stop:1 #7f8c8d);"
        "    border: none;"
        "    border-radius: 20px;"
        "    padding: 10px 20px;"
        "    min-width: 100px;"
        "}"
        
        "#navButton:hover {"
        "    background: qlineargradient(x1:0, y1:0, x2:0, y2:1, "
        "                                stop:0 #7f8c8d, stop:1 #6c7b7d);"
        "}"
        
        "#knowledgeContentEdit, #explanationEdit {"
        "    background: white;"
        "    border: 2px solid #bdc3c7;"
        "    border-radius: 10px;"
        "    padding: 15px;"
        "    font-size: 14px;"
        "    line-height: 1.6;"
        "}"
        
        "#questionLabel {"
        "    font-size: 16px;"
        "    font-weight: bold;"
        "    color: #2c3e50;"
        "    background: white;"
        "    border: 2px solid #3498db;"
        "    border-radius: 10px;"
        "    padding: 15px;"
        "    margin: 10px 0;"
        "}"
        
        "#optionButton {"
        "    font-size: 14px;"
        "    color: #2c3e50;"
        "    background: white;"
        "    border: 2px solid #bdc3c7;"
        "    border-radius: 8px;"
        "    padding: 10px 15px;"
        "    margin: 5px 0;"
        "}"
        
        "#optionButton:checked {"
        "    border-color: #3498db;"
        "    background: #ebf3fd;"
        "}"
        
        "#submitButton, #nextQuestionButton {"
        "    font-size: 16px;"
        "    font-weight: bold;"
        "    color: white;"
        "    background: qlineargradient(x1:0, y1:0, x2:0, y2:1, "
        "                                stop:0 #27ae60, stop:1 #229954);"
        "    border: none;"
        "    border-radius: 20px;"
        "    padding: 12px 25px;"
        "    min-width: 120px;"
        "}"
        
        "#submitButton:hover, #nextQuestionButton:hover {"
        "    background: qlineargradient(x1:0, y1:0, x2:0, y2:1, "
        "                                stop:0 #229954, stop:1 #1e7e34);"
        "}"
        
        "#submitButton:disabled {"
        "    background: #bdc3c7;"
        "    color: #7f8c8d;"
        "}"
        
        "#resultLabel {"
        "    font-size: 18px;"
        "    font-weight: bold;"
        "    padding: 10px;"
        "    border-radius: 8px;"
        "    margin: 10px 0;"
        "}"
        
        "#scoreLabel {"
        "    font-size: 16px;"
        "    font-weight: bold;"
        "    color: #2c3e50;"
        "}"
        
        "#finalResultLabel {"
        "    font-size: 24px;"
        "    font-weight: bold;"
        "    color: #2c3e50;"
        "}"
        
        "#finalScoreLabel {"
        "    font-size: 20px;"
        "    color: #34495e;"
        "}"
        
        "#finalButton {"
        "    font-size: 16px;"
        "    font-weight: bold;"
        "    color: white;"
        "    background: qlineargradient(x1:0, y1:0, x2:0, y2:1, "
        "                                stop:0 #e74c3c, stop:1 #c0392b);"
        "    border: none;"
        "    border-radius: 20px;"
        "    padding: 12px 25px;"
        "    min-width: 150px;"
        "}"
        
        "#finalButton:hover {"
        "    background: qlineargradient(x1:0, y1:0, x2:0, y2:1, "
        "                                stop:0 #c0392b, stop:1 #a93226);"
        "}"
        
        "QProgressBar {"
        "    border: 2px solid #bdc3c7;"
        "    border-radius: 8px;"
        "    background: white;"
        "    text-align: center;"
        "    font-weight: bold;"
        "    color: #2c3e50;"
        "}"
        
        "QProgressBar::chunk {"
        "    background: qlineargradient(x1:0, y1:0, x2:0, y2:1, "
        "                                stop:0 #3498db, stop:1 #2980b9);"
        "    border-radius: 6px;"
        "}"
    );
}

void NutritionQuizWindow::startQuiz()
{
    // Âä†ËΩΩÁü•ËØÜÂÜÖÂÆπÂíåÈ¢òÁõÆ
    if (!loadKnowledgeFromDatabase() || !loadQuestionsFromDatabase()) {
        QMessageBox::warning(this, "ÈîôËØØ", "Êó†Ê≥ïÂä†ËΩΩËê•ÂÖªÁü•ËØÜÊï∞ÊçÆÔºåËØ∑Ê£ÄÊü•Êï∞ÊçÆÂ∫ìËøûÊé•„ÄÇ");
        return;
    }
    
    // ÈáçÁΩÆÁä∂ÊÄÅ
    currentKnowledgeIndex = 0;
    currentQuestionIndex = 0;
    correctAnswers = 0;
    
    // ÊòæÁ§∫‰∏ªÁïåÈù¢
    stackedWidget->setCurrentWidget(mainWidget);
    show();
}

void NutritionQuizWindow::showKnowledge()
{
    displayKnowledge();
    stackedWidget->setCurrentWidget(knowledgeWidget);
}

bool NutritionQuizWindow::loadKnowledgeFromDatabase()
{
    knowledgeItems.clear();
    
    if (!database.isOpen()) {
        qDebug() << "Êï∞ÊçÆÂ∫ìÊú™ËøûÊé•";
        return false;
    }
    
    QSqlQuery query(database);
    query.prepare("SELECT KnowledgeID, Title, Content, Category, ImagePath FROM NutritionKnowledge ORDER BY KnowledgeID");
    
    if (!query.exec()) {
        qDebug() << "Âä†ËΩΩËê•ÂÖªÁü•ËØÜÂ§±Ë¥•:" << query.lastError().text();
        return false;
    }
    
    while (query.next()) {
        KnowledgeItem item;
        item.knowledgeId = query.value(0).toInt();
        item.title = query.value(1).toString();
        item.content = query.value(2).toString();
        item.category = query.value(3).toString();
        item.imagePath = query.value(4).toString();
        knowledgeItems.append(item);
    }
    
    qDebug() << "Âä†ËΩΩ‰∫Ü" << knowledgeItems.size() << "Êù°Ëê•ÂÖªÁü•ËØÜ";
    return !knowledgeItems.isEmpty();
}

bool NutritionQuizWindow::loadQuestionsFromDatabase()
{
    questions.clear();
    
    if (!database.isOpen()) {
        qDebug() << "Êï∞ÊçÆÂ∫ìÊú™ËøûÊé•";
        return false;
    }
    
    // ÈöèÊú∫ÈÄâÊã©5ÈÅìÈ¢òÁõÆ
    QSqlQuery query(database);
    query.prepare("SELECT QuestionID, QuestionText, OptionA, OptionB, OptionC, OptionD, "
                  "CorrectAnswer, Explanation, DifficultyLevel, Category "
                  "FROM NutritionQuestions ORDER BY RANDOM() LIMIT ?");
    query.addBindValue(totalQuestions);
    
    if (!query.exec()) {
        qDebug() << "Âä†ËΩΩËê•ÂÖªÈ¢òÁõÆÂ§±Ë¥•:" << query.lastError().text();
        return false;
    }
    
    while (query.next()) {
        QuizQuestion question;
        question.questionId = query.value(0).toInt();
        question.questionText = query.value(1).toString();
        question.optionA = query.value(2).toString();
        question.optionB = query.value(3).toString();
        question.optionC = query.value(4).toString();
        question.optionD = query.value(5).toString();
        question.correctAnswer = query.value(6).toString();
        question.explanation = query.value(7).toString();
        question.difficultyLevel = query.value(8).toInt();
        question.category = query.value(9).toString();
        questions.append(question);
    }
    
    qDebug() << "Âä†ËΩΩ‰∫Ü" << questions.size() << "ÈÅìÈ¢òÁõÆ";
    return questions.size() == totalQuestions;
}

void NutritionQuizWindow::onKnowledgeButtonClicked()
{
    showKnowledge();
}

void NutritionQuizWindow::displayKnowledge()
{
    if (knowledgeItems.isEmpty()) {
        return;
    }
    
    updateKnowledgeDisplay(currentKnowledgeIndex);
}

void NutritionQuizWindow::updateKnowledgeDisplay(int index)
{
    if (index < 0 || index >= knowledgeItems.size()) {
        return;
    }
    
    const KnowledgeItem& item = knowledgeItems[index];
    
    QString content = QString("<h2 style='color: #2c3e50; text-align: center;'>%1</h2>")
                     .arg(item.title);
    
    if (!item.category.isEmpty()) {
        content += QString("<p style='color: #7f8c8d; text-align: center; font-style: italic;'>Á±ªÂà´: %1</p>")
                  .arg(item.category);
    }
    
    content += QString("<div style='line-height: 1.8; font-size: 14px; color: #2c3e50;'>%1</div>")
              .arg(item.content);
    
    knowledgeContentEdit->setHtml(content);
    
    // Êõ¥Êñ∞ËøõÂ∫¶Êù°
    knowledgeProgressBar->setMaximum(knowledgeItems.size());
    knowledgeProgressBar->setValue(index + 1);
    knowledgeProgressBar->setFormat(QString("Á¨¨ %1 È°µÔºåÂÖ± %2 È°µ")
                                   .arg(index + 1).arg(knowledgeItems.size()));
    
    // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
    prevKnowledgeButton->setEnabled(index > 0);
    nextKnowledgeButton->setEnabled(index < knowledgeItems.size() - 1);
}

void NutritionQuizWindow::onNextStepClicked()
{
    // ÂàáÊç¢Âà∞Á≠îÈ¢òÁïåÈù¢
    currentQuestionIndex = 0;
    correctAnswers = 0;
    displayCurrentQuestion();
    stackedWidget->setCurrentWidget(quizWidget);
}

void NutritionQuizWindow::displayCurrentQuestion()
{
    if (currentQuestionIndex >= questions.size()) {
        showFinalResult();
        return;
    }
    
    const QuizQuestion& question = questions[currentQuestionIndex];
    
    questionLabel->setText(QString("Á¨¨ %1 È¢ò: %2")
                          .arg(currentQuestionIndex + 1)
                          .arg(question.questionText));
    
    optionAButton->setText(QString("A. %1").arg(question.optionA));
    optionBButton->setText(QString("B. %1").arg(question.optionB));
    optionCButton->setText(QString("C. %1").arg(question.optionC));
    optionDButton->setText(QString("D. %1").arg(question.optionD));
    
    // ÈáçÁΩÆÈÄâÊã©Áä∂ÊÄÅ
    answerButtonGroup->setExclusive(false);
    optionAButton->setChecked(false);
    optionBButton->setChecked(false);
    optionCButton->setChecked(false);
    optionDButton->setChecked(false);
    answerButtonGroup->setExclusive(true);
    
    submitAnswerButton->setEnabled(false);
    submitAnswerButton->show();
    resultLabel->hide();
    explanationEdit->hide();
    nextQuestionButton->hide();
    
    // Êõ¥Êñ∞ËøõÂ∫¶Êù°ÂíåÂæóÂàÜ
    quizProgressBar->setMaximum(totalQuestions);
    quizProgressBar->setValue(currentQuestionIndex + 1);
    quizProgressBar->setFormat(QString("Á¨¨ %1 È¢òÔºåÂÖ± %2 È¢ò")
                              .arg(currentQuestionIndex + 1).arg(totalQuestions));
    
    scoreLabel->setText(QString("ÂæóÂàÜ: %1/%2")
                       .arg(correctAnswers).arg(currentQuestionIndex));
}

void NutritionQuizWindow::onAnswerSelected()
{
    submitAnswerButton->setEnabled(true);
    
    // Ëé∑ÂèñÈÄâÊã©ÁöÑÁ≠îÊ°à
    int selectedId = answerButtonGroup->checkedId();
    switch (selectedId) {
    case 0: currentUserAnswer = "A"; break;
    case 1: currentUserAnswer = "B"; break;
    case 2: currentUserAnswer = "C"; break;
    case 3: currentUserAnswer = "D"; break;
    default: currentUserAnswer = ""; break;
    }
}

void NutritionQuizWindow::onSubmitAnswerClicked()
{
    if (currentUserAnswer.isEmpty()) {
        return;
    }
    
    checkAnswer();
}

void NutritionQuizWindow::checkAnswer()
{
    const QuizQuestion& question = questions[currentQuestionIndex];
    bool isCorrect = (currentUserAnswer == question.correctAnswer);
    
    if (isCorrect) {
        correctAnswers++;
    }
    
    showQuestionResult(isCorrect);
    
    // ËÆ∞ÂΩïÁ≠îÈ¢òÁªìÊûúÂà∞Êï∞ÊçÆÂ∫ìÔºàÂèØÈÄâÔºâ
    // recordAnswerToDatabase(question.questionId, currentUserAnswer, isCorrect);
}

void NutritionQuizWindow::showQuestionResult(bool isCorrect)
{
    const QuizQuestion& question = questions[currentQuestionIndex];
    
    submitAnswerButton->hide();
    
    if (isCorrect) {
        resultLabel->setText("üéâ ÂõûÁ≠îÊ≠£Á°ÆÔºÅ");
        resultLabel->setStyleSheet("#resultLabel { background: #d5f4e6; color: #27ae60; }");
    } else {
        resultLabel->setText(QString("‚ùå ÂõûÁ≠îÈîôËØØÔºÅÊ≠£Á°ÆÁ≠îÊ°àÊòØ: %1").arg(question.correctAnswer));
        resultLabel->setStyleSheet("#resultLabel { background: #fadbd8; color: #e74c3c; }");
    }
    
    resultLabel->show();
    
    // ÊòæÁ§∫Ëß£Èáä
    if (!question.explanation.isEmpty()) {
        explanationEdit->setPlainText(question.explanation);
        explanationEdit->show();
    }
    
    // Êõ¥Êñ∞ÂæóÂàÜÊòæÁ§∫
    scoreLabel->setText(QString("ÂæóÂàÜ: %1/%2")
                       .arg(correctAnswers).arg(currentQuestionIndex + 1));
    
    // ÊòæÁ§∫‰∏ã‰∏ÄÈ¢òÊåâÈíÆ
    if (currentQuestionIndex < totalQuestions - 1) {
        nextQuestionButton->setText("‰∏ã‰∏ÄÈ¢ò");
    } else {
        nextQuestionButton->setText("Êü•ÁúãÁªìÊûú");
    }
    nextQuestionButton->show();
}

void NutritionQuizWindow::onNextQuestionClicked()
{
    currentQuestionIndex++;
    
    if (currentQuestionIndex < totalQuestions) {
        displayCurrentQuestion();
    } else {
        showFinalResult();
    }
}

void NutritionQuizWindow::showFinalResult()
{
    double percentage = (double)correctAnswers / totalQuestions * 100;
    
    QString resultText;
    if (percentage >= 80) {
        resultText = "üéâ ‰ºòÁßÄÔºÅüéâ\n‰Ω†ÂØπËê•ÂÖªÁü•ËØÜÊéåÊè°ÂæóÂæàÂ•ΩÔºÅ";
    } else if (percentage >= 60) {
        resultText = "üëç ËâØÂ•ΩÔºÅüëç\nÁªßÁª≠Âä†Ê≤πÔºåËê•ÂÖªÁü•ËØÜÂæàÈáçË¶ÅÔºÅ";
    } else {
        resultText = "üí™ Âä†Ê≤πÔºÅüí™\nÂ§öÂ≠¶‰π†Ëê•ÂÖªÁü•ËØÜÔºåÂÅ•Â∫∑ÁîüÊ¥ªÔºÅ";
    }
    
    finalResultLabel->setText(resultText);
    finalScoreLabel->setText(QString("ÊúÄÁªàÂæóÂàÜ: %1/%2 (%.1f%%)")
                            .arg(correctAnswers).arg(totalQuestions).arg(percentage));
    
    stackedWidget->setCurrentWidget(resultWidget);
}

void NutritionQuizWindow::onRetryClicked()
{
    // ÈáçÊñ∞ÂºÄÂßãÁ≠îÈ¢ò
    if (loadQuestionsFromDatabase()) {
        resetQuiz();
        displayCurrentQuestion();
        stackedWidget->setCurrentWidget(quizWidget);
    } else {
        QMessageBox::warning(this, "ÈîôËØØ", "Êó†Ê≥ïÈáçÊñ∞Âä†ËΩΩÈ¢òÁõÆÔºåËØ∑Ê£ÄÊü•Êï∞ÊçÆÂ∫ìËøûÊé•„ÄÇ");
    }
}

void NutritionQuizWindow::onBackToMenuClicked()
{
    emit backToMenu();
    close();
}

void NutritionQuizWindow::resetQuiz()
{
    currentQuestionIndex = 0;
    correctAnswers = 0;
    currentUserAnswer.clear();
}

void NutritionQuizWindow::onFinishQuizClicked()
{
    emit quizCompleted();
    close();
}